<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Adicionar Caixa</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&amp;display=swap">
    <link rel="stylesheet" href="assets/fonts/fontawesome-all.min.css">
    <link rel="stylesheet" href="assets/css/styles.min.css">
</head>

<body id="page-top" onload="validarSessao(), listarCaixas(), verificarCargo()">
    <span id="mensagem_erro" class="ms"></span>
    <div id="wrapper">
        <nav class="navbar navbar-dark align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0"
            style="background: rgb(0, 132, 156);">
            <div class="container-fluid d-flex flex-column p-0"><a
                    class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="#">
                    <div class="sidebar-brand-icon"><img src="assets/img/logo/logoWhite.png" width="60%"
                            style="margin-top: 10%;"></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul id="accordionSidebar" class="navbar-nav text-light">
					<li class="nav-item"><a class="nav-link" href="listarUser.html" id="link_list_user"><i class="fas fa-user"></i><span>Lista de usuários</span></a><a class="nav-link" href="addUser.html" id="link_add_user"><i class="fas fa-user-plus"></i><span>Adicionar Usuário</span></a><a class="nav-link" href="addCaixa.html" id="link_add_caixa"><i class="fas fa-server"></i><span>Cadastrar Caixa</span></a><a class="nav-link" href="dashMapa.html" id="link_dash_mapa"><i class="fas fa-map"></i><span>Dash - Região</span></a></li>
                    <li class="nav-item"><a id="link_dash" class="nav-link" data-bs-toggle="collapse" href="#div_caixas" role="button" aria-expanded="false" aria-controls="div_caixas"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
						<div class="collapse show" id="div_caixas">	
						</div>
					</li>
				</ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0"
                        id="sidebarToggle" type="button"></button></div>
            </div>
        </nav>
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <nav class="navbar navbar-light navbar-expand bg-white shadow mb-4 topbar static-top">
                    <div class="container-fluid">
                        <h5 style="color: var(--bs-navbar-brand-color);" id="titulo_cargo">Administrador</h5>
                        <ul class="navbar-nav flex-nowrap ms-auto">
                            <li class="nav-item dropdown no-arrow mx-1"></li>
                            <li class="nav-item dropdown no-arrow mx-1">
                                <div class="shadow dropdown-list dropdown-menu dropdown-menu-end"
                                    aria-labelledby="alertsDropdown"></div>
                            </li>
                            <div class="d-none d-sm-block topbar-divider"></div>
                            <li class="nav-item dropdown no-arrow">
                                <div class="nav-item dropdown no-arrow"><a class="dropdown-toggle nav-link"
                                        aria-expanded="false" data-bs-toggle="dropdown" href="#"><span
                                            class="d-none d-lg-inline me-2 text-gray-600 small" id="span_user">Kash
                                            User</span><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                                            viewBox="0 0 24 24" fill="none" style="font-size: 33px;">
                                            <path
                                                d="M5.12104 17.8037C7.15267 16.6554 9.4998 16 12 16C14.5002 16 16.8473 16.6554 18.879 17.8037M15 10C15 11.6569 13.6569 13 12 13C10.3431 13 9 11.6569 9 10C9 8.34315 10.3431 7 12 7C13.6569 7 15 8.34315 15 10ZM21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round"></path>
                                        </svg></a>
                                    <div class="dropdown-menu shadow dropdown-menu-end animated--grow-in"><a
                                            class="dropdown-item" href="#"><i
                                                class="fas fa-sign-out-alt fa-sm fa-fw me-2 text-gray-400"></i>&nbsp;Sair</a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
                <div class="container-fluid">
                    <div class="row mb-3">
                        <div class="col-auto col-lg-8 col-xl-12">
                            <div class="row">
                                <div class="col-lg-12 col-xl-12 offset-lg-3 offset-xl-0">
                                    <div class="card shadow mb-3">
                                        <div class="card-header py-3">
                                            <p class="text-primary m-0 fw-bold">Cadastrar caixa eletrônico</p>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col">
                                                    <div class="mb-3"><label class="form-label"
                                                            for="email"><strong>Localização da
                                                                máquina(CEP)</strong><br></label><input
                                                            class="form-control" type="Number" id="ipt_cep">
                                                    </div>
                                                    <div class="mb-3"><label class="form-label"><strong>Serial
                                                                Number:</strong><br></label><input class="form-control"
                                                            type="text" id="ipt_serial_number" placeholder="">
                                                    </div>
                                                    <div class="mb-3"><label class="form-label"><strong>Nome da
                                                                Máquina</strong><br></label><input class="form-control"
                                                            type="text" id="ipt_nome_maquina" placeholder="">
                                                    </div>
                                                    <div id="div_primeiro_componente">
                                                        <label class="form-label"><strong id="strong_titulo">Primeiro
                                                                componente</strong><br /></label>
                                                        <select class="form-select" id="slct_componente"
                                                            onchange="verificarOutro()">
                                                            <option value="cpu" selected>CPU</option>
                                                            <option value="ram">RAM</option>
                                                            <option value="disco">DISCO</option>
                                                            <option value="outro">Outro</option>
                                                        </select>
                                                    </div>

                                                    <div class="text-center mb-3"><button class="btn btn-primary btn-sm"
                                                            onclick="recuperarDados()" id="btn_cadastro"
                                                            style="margin-top: 2%;">Cadastrar
                                                            Máquina</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <footer class="bg-white sticky-footer">
                        <div class="container my-auto">
                            <div class="text-center my-auto copyright"><span>Copyright © KASH+&nbsp;2022</span></div>
                        </div>
                    </footer>
                </div>
            </div>
            <script src="assets/bootstrap/js/bootstrap.min.js"></script>
            <script src="assets/js/script.min.js"></script>
            <script src="../js/funcoes.js"></script>
            <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>
<script>
    var componente = "";
    var usarOutro = false;
    var cep = '';
    var regiao = '';

    function verificarOutro() {
        var valor = document.getElementById("slct_componente").value;

        if (valor == "outro") {
            Swal.fire({
                title: 'Insira o nome do componente',
                input: 'text',
                inputAttributes: {
                    autocapitalize: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'confirmar',
                preConfirm: (texto) => {
                    componente = texto;
                }

            }).then(() => {
                usarOutro = true;
            })
        }
        else {
            return false;
        }
    }

    function recuperarDados() {

        cep = ipt_cep.value;

        if (cep != "") {
            var script = document.createElement('script');
            script.src = 'https://viacep.com.br/ws/' + cep + '/json/?callback=cadastrarCaixa';
            document.body.appendChild(script);
        } else {
            alert("Insira um CEP")
        }
    }

    function cadastrarCaixa(conteudo) {

        var cidades = ["São Paulo", "Cajamar", "Caieiras", "Franco da Rocha", "Francisco Morato", "Mairiporã", "Pirapora do Bom Jesus", "Santana de Parnaíba", "Barueri", "Osasco", "Carapicuíba", "Jandira", "Itapevi", "Vargem Grande Paulista", "Cotia", "Taboão da Serra", "Embu das Artes", "Itapecirica da Serra", "Embu-Guaçu", "São Lourenço da Serra", "Juquitiba", "São Caetano do Sul", "Diadema", "São Bernardo do Campo", "Santo André", "Mauá", "Ribeirão Pires", "Rio Grande da Serra", "Guarulhos", "Arujá", "Santa Isabel", "Itaquaquecetuba", "Poá", "Ferraz de Vasconcelos", "Suzano", "Guararema", "Mogi das Cruzes", "Biritiba Mirim", "Salesópolis"]
        var saoPaulo = ["São Paulo"]
        var regiaoNorte = ["Cajamar", "Caieiras", "Franco da Rocha", "Francisco Morato", "Mairiporã"]
        var regiaoOeste = ["Pirapora do Bom Jesus", "Santana de Parnaíba", "Barueri", "Osasco", "Carapicuíba", "Jandira", "Itapevi"]
        var regiaoSudoeste = ["Vargem Grande Paulista", "Cotia", "Taboão da Serra", "Embu das Artes", "Itapecirica da Serra", "Embu-Guaçu", "São Lourenço da Serra", "Juquitiba"]
        var regiaoSudeste = ["São Caetano do Sul", "Diadema", "São Bernardo do Campo", "Santo André", "Mauá", "Ribeirão Pires", "Rio Grande da Serra"]
        var regiaoLeste = ["Guarulhos", "Arujá", "Santa Isabel", "Itaquaquecetuba", "Poá", "Ferraz de Vasconcelos", "Suzano", "Guararema", "Mogi das Cruzes", "Biritiba Mirim", "Salesópolis"]

        var cobreRegiao = 0;

        var cidade = conteudo.localidade;

        for (var index = 0; index < saoPaulo.length; index++) {
            if (cidade == saoPaulo[index]) {
                cobreRegiao = 1;
                regiao = 'São Paulo';
            }
        }
        for (var index = 0; index < regiaoNorte.length; index++) {
            if (cidade == regiaoNorte[index]) {
                cobreRegiao = 1;
                regiao = 'Norte';
            }
        }
        for (var index = 0; index < regiaoOeste.length; index++) {
            if (cidade == regiaoOeste[index]) {
                cobreRegiao = 1;
                regiao = 'Oeste';
            }
        }
        for (var index = 0; index < regiaoSudoeste.length; index++) {
            if (cidade == regiaoSudoeste[index]) {
                cobreRegiao = 1;
                regiao = 'Sudoeste';
            }
        }
        for (var index = 0; index < regiaoSudeste.length; index++) {
            if (cidade == regiaoSudeste[index]) {
                cobreRegiao = 1;
                regiao = 'Sudeste';
            }
        }
        for (var index = 0; index < regiaoLeste.length; index++) {
            if (cidade == regiaoLeste[index]) {
                cobreRegiao = 1;
                regiao = 'Leste';
            }
        }

        if (cobreRegiao == 0) {
            alert("Desculpe, não cobrimos sua região")
        }

        //Recupere o valor da nova input pelo nome do id
        // Agora vá para o método fetch logo abaixo
        var nomeVar = ipt_nome_maquina.value;
        var cepVar = cep;
        var serialNumberVar = ipt_serial_number.value;
        var cnpjVar = sessionStorage.BANCO_ID;
        var cidadeVar = cidade;
        var regiaoVar = regiao;

        if (!usarOutro) {
            componente = document.getElementById("slct_componente").value;
        }

        if (cepVar == "" || serialNumberVar == "" || nomeVar == "") {
            mensagem_erro.classList.add("alerta")
            mensagem_erro.style.display = "flex";
            mensagem_erro.innerHTML = "Por favor não deixe nenhum campo em branco";
            setTimeout(() => {
                mensagem_erro.style.display = "none";
                mensagem_erro.classList.remove("alerta");
                mensagem_erro.innerHTML = "";
            }, 5000)

            return false;
        }

        // Enviando o valor da nova input
        fetch("/usuarios/cadastrarMaquina", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                nomeServer: nomeVar,
                cepServer: cepVar,
                serialNumberServer: serialNumberVar,
                componenteServer: componente,
                cnpjServer: cnpjVar,
                cidadeServer: cidadeVar,
                regiaoServer: regiaoVar
            })
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                Swal.fire({
                    title: 'Cadastro da maquina e componente realizado com sucesso!',
                    text: "Deseja cadastrar outro componente?",
                    icon: 'success',
                    showCancelButton: true,
                    cancelButtonText: 'Não',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sim'
                }).then((result) => {
                    if (result.isConfirmed) {
                        botao = document.getElementById("btn_cadastro");
                        strong_titulo.innerHTML = "Próximo componente";
                        ipt_cep.disabled = true;
                        ipt_nome_maquina.disabled = true;
                        ipt_serial_number.disabled = true;
                        botao.innerHTML = "Cadastrar novo componente";
                        botao.setAttribute('onclick', 'cadastrarComponente()')
                    }
                    else {
                        Swal.fire({
                            icon: 'success',
                            title: 'Cadastro de máquina e componentes finalizados',
                        })
                        window.location.href = "./addCaixa.html";
                    }
                })

            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
                mensagem_erro.classList.add("erro");
                mensagem_erro.style.display = "flex";

                mensagem_erro.innerHTML = "Houve um erro ao tentar realizr o cadastro!";

                setTimeout(() => {
                    mensagem_erro.style.display = "none";
                    mensagem_erro.classList.remove("erro");
                    mensagem_erro.innerHTML = "";
                }, 5000)
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

        return false;
    
    }

    function cadastrarComponente() {
        serialNumberVar = ipt_serial_number.value;

        if (!usarOutro) {
            componente = document.getElementById("slct_componente").value;
        }

        fetch("/usuarios/cadastrarComponente", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                serialNumberServer: serialNumberVar,
                componenteServer: componente,
            })
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                Swal.fire({
                    title: 'Cadastro de outro componente realizado com sucesso!',
                    text: "Deseja cadastrar outro componente?",
                    icon: 'success',
                    showCancelButton: true,
                    cancelButtonText: 'Não',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sim'
                }).then((result) => {
                    if (result.isConfirmed) {
                        botao = getElementById("btn_cadastro");
                        strong_titulo.innerHTML = "Próximo componente";
                        ipt_cep.disabled = true;
                        ipt_nome_maquina.disabled = true;
                        ipt_serial_number.disabled = true;
                        botao.innerHTML = "Cadastrar novo componente";
                        botao.setAttribute('onclick', 'cadastrarComponente()')
                    }
                    else {
                        Swal.fire({
                            icon: 'success',
                            title: 'Cadastro de máquina e componentes finalizados',
                        })
                        window.location.href = "./addCaixa.html";
                    }
                })

            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
                mensagem_erro.classList.add("erro");
                mensagem_erro.style.display = "flex";

                mensagem_erro.innerHTML = "Houve um erro ao tentar realizr o cadastro!";

                setTimeout(() => {
                    mensagem_erro.style.display = "none";
                    mensagem_erro.classList.remove("erro");
                    mensagem_erro.innerHTML = "";
                }, 5000)
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

        return false;

    }

</script>